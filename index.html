<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ffd9e6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Our California Word Search</title>

  <!-- Beachy, cute fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Pastel sunset ‚Üí ocean */
      --sky-top:#ffe6ef; --sky-mid:#ffd9c8; --sunset:#ffd1dc;
      --ocean:#c6f0ff;  --sea:#9dd9ff;
      --ink:#233142;    --heart:#ff5f9e; --rose:#ff8fb1;
      --grid-bg:#ffffffcc; --grid-cell:#fff; --grid-border:#f4e7ff;
      --found:#ffd9e6;  --accent:#ff7aa2; --accent-2:#78c5ff;
      --ok:#1f9d7a;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
        linear-gradient(180deg,var(--sky-top) 0%, var(--sky-mid) 30%, var(--sunset) 50%, var(--ocean) 70%, var(--sea) 100%);
      min-height:100svh;
      padding-bottom: var(--safe-bottom);
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: contain;
    }

    /* Floating hearts */
    .hearts{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:0}
    .hearts span{
      position:absolute;bottom:-2rem;opacity:.22;color:var(--heart);
      font-size:clamp(18px,2.8vw,28px);
      animation:floatUp linear forwards;
    }
    @keyframes floatUp{
      0%{transform:translateY(0) translateX(0) rotate(0);opacity:.14}
      100%{transform:translateY(-120vh) translateX(var(--shift)) rotate(18deg);opacity:0}
    }

    .wrap{position:relative;z-index:1;max-width:980px;margin:0 auto;padding:calc(10px + var(--safe-top)) 14px 18px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px
    }
    .title{display:flex;align-items:center;gap:10px}
    .logo{
      width:50px;height:50px;border-radius:50%;display:grid;place-items:center;
      background:radial-gradient(circle at 40% 40%, #fff 0 38%, #ffd1dc 39% 100%);
      box-shadow:0 6px 14px rgba(0,0,0,.08), inset 0 0 0 2px #fff7;
      font-family:"Pacifico",cursive;color:var(--heart); user-select:none
    }
    h1{
      font-family:"Pacifico",cursive;font-weight:400;margin:0;
      font-size:clamp(22px,5.2vw,36px);letter-spacing:.3px;color:#c74173;text-shadow:0 2px 0 #fff8
    }
    .subtitle{margin:2px 0 0;font-size:13px;opacity:.8}

    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{
      border:0;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:600;
      background:linear-gradient(180deg,#fff,#ffeef6);
      box-shadow:0 2px 0 #ffb7ce88, 0 6px 16px rgba(0,0,0,.08);
      color:#c13b73; transition:transform .05s ease, filter .18s ease
    }
    button:hover{filter:brightness(1.03)}
    button:active{transform:translateY(1px)}
    .btn-secondary{background:linear-gradient(180deg,#fff,#eef7ff);color:#1b6aa6;box-shadow:0 2px 0 #a6d5ff88,0 6px 16px rgba(0,0,0,.08)}
    .btn-ghost{background:transparent;border:2px dashed #ffffff88;box-shadow:none;color:#2a5b8a}
    .deck{display:grid;gap:14px;grid-template-columns:1fr}
    @media (min-width:900px){ .deck{grid-template-columns:minmax(0,1.15fr) minmax(0,.85fr)} }

    .card{
      background:linear-gradient(180deg,var(--grid-bg),#fff);
      border-radius:18px;padding:14px;
      box-shadow:0 10px 26px rgba(0,0,0,.10), inset 0 0 0 1px #fff6;
    }
    .pill{display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fff7);
      box-shadow:inset 0 0 0 1px #f0eaff;font-size:14px}
    .progress{font-size:13px;opacity:.9}

    /* Grid */
    .grid-wrap{display:grid;place-items:center}
    .grid{
      --size:16;
      width:min(94vw,680px);aspect-ratio:1/1;display:grid;
      grid-template-columns:repeat(var(--size),1fr);grid-auto-rows:1fr;gap:2px;
      background:linear-gradient(180deg,#fff8,#fff1);
      border-radius:16px;padding:8px;
      box-shadow:inset 0 0 0 1px var(--grid-border), 0 6px 22px rgba(0,0,0,.07);
      touch-action:none;user-select:none
    }
    .cell{
      display:grid;place-items:center;font-weight:600;background:var(--grid-cell);
      border-radius:10px;box-shadow:inset 0 0 0 1px #f3e7ff;
      font-size:clamp(14px,2.6vw,22px);letter-spacing:.5px;
      transition:background .08s ease, color .08s ease, transform .06s ease;
    }
    .cell.selecting{background:#fff4fa}
    .cell.found{background:var(--found);color:#b22762;box-shadow:inset 0 0 0 2px #ffc3da}
    .cell.hint{outline:2px dashed #ffc1db}

    /* Clues */
    .clues{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:8px;
      max-height:min(56vh,500px);overflow:auto;-webkit-overflow-scrolling:touch}
    .clues li{
      background:linear-gradient(180deg,#fff,#fff8);border-radius:12px;padding:10px 12px;
      box-shadow:inset 0 0 0 1px #f1e9ff;display:flex;gap:10px;align-items:flex-start
    }
    .clues .status{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;
      font-size:14px;flex:0 0 22px;background:#ffe8f1;color:#c13b73;border:1px solid #ffd2e2}
    .clues li.found .status{background:#eafff5;color:var(--ok);border-color:#b9f1de}
    .clue-text{font-size:14px;line-height:1.35}
    .clue-answer{opacity:.6;font-size:12px;margin-top:2px;display:none}
    .show-answers .clue-answer{display:block}

    /* Editor hidden unless builder mode */
    #editorBox{display:none}
    body.builder #editorBox{display:block}

    /* Win ribbon */
    .ribbon{position:fixed;inset:0;display:none;place-items:center;z-index:3;backdrop-filter:blur(3px)}
    .ribbon.show{display:grid}
    .ribbon .inner{
      background:linear-gradient(180deg,#fff,#fff5f9);border-radius:18px;padding:20px 18px;text-align:center;
      box-shadow:0 18px 40px rgba(0,0,0,.12), inset 0 0 0 1px #ffd6e6;
      max-width:min(92vw,420px);animation:pop .18s ease
    }
    @keyframes pop{from{transform:scale(.97);opacity:.6}to{transform:scale(1);opacity:1}}
    .inner h3{font-family:"Pacifico";font-weight:400;margin:0 0 8px;color:#c13b73}
    .inner p{margin:0 0 12px}

    footer{margin-top:8px;text-align:center;font-size:12px;opacity:.7}
  </style>
</head>
<body>
  <!-- Floating hearts -->
  <div class="hearts" id="bgHearts" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo" id="logo">‚ô•</div>
        <div>
          <h1 id="pageTitle">Our California Word Search</h1>
          <p class="subtitle">Beach Boys energy, pastel sunset, and all our little memories üå¥</p>
        </div>
      </div>
      <div class="controls">
        <button id="btnRegenerate" title="Shuffle letters & placements">Regenerate ‚ú®</button>
        <button class="btn-secondary" id="btnHighlight" title="Toggle highlight for all answers">Highlight All</button>
        <button class="btn-secondary" id="btnAnswers" title="Toggle showing the answer words next to clues">Show Answers</button>
      </div>
    </header>

    <div class="deck">
      <!-- Grid -->
      <section class="card grid-wrap">
        <div class="pill">
          <span class="progress"><strong id="foundCount">0</strong>/<span id="totalCount">0</span> found</span>
          <span style="font-size:12px;opacity:.8">Tap & drag in straight lines (‚Üí ‚Üì ‚Üò)</span>
        </div>
        <div class="grid" id="grid" aria-label="Word search grid"></div>
      </section>

      <!-- Clues (no spoilers by default) -->
      <section class="card panel">
        <ul class="clues" id="clues"></ul>

        <!-- Hidden builder for you only -->
        <details id="editorBox">
          <summary>‚úèÔ∏è Builder Mode (words & settings)</summary>
          <div class="editor" style="display:grid;gap:10px;margin-top:8px">
            <p style="font-size:12px;opacity:.75">
              Enter one per line: <code>Display Word | Clue</code>.  
              Spaces & punctuation are removed for the grid; digits are allowed (but you asked to avoid them).
            </p>
            <textarea id="lines" style="width:100%;min-height:170px;resize:vertical;border:1px solid #e6dfff;border-radius:12px;padding:10px 12px;background:#fff;font:13px/1.4 Poppins,sans-serif;"></textarea>
            <div class="pill" style="display:flex;gap:12px;flex-wrap:wrap">
              <label><input type="checkbox" id="diagonals" checked /> Allow diagonal (‚Üò)</label>
              <label><input type="checkbox" id="autoSize" checked /> Auto size</label>
              <label>Grid size <input type="number" id="gridSize" value="16" min="12" max="22" style="width:82px;margin-left:6px"/></label>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button id="btnApply" class="btn-secondary">Save & Regenerate</button>
              <button id="btnShare" class="btn">Share Link üîó</button>
              <button id="btnReset" class="btn-ghost">Reset Progress</button>
            </div>
          </div>
        </details>
      </section>
    </div>

    <footer>Made with üíñ + ‚òÄÔ∏è + üåä ‚Äî all in your browser.</footer>
  </div>

  <!-- Win ribbon -->
  <div class="ribbon" id="win">
    <div class="inner">
      <h3>We found them all! üíò</h3>
      <p id="winMsg">You‚Äôre my favorite adventure.</p>
      <button id="btnCloseWin">Aww ü•π</button>
    </div>
  </div>

  <script>
    /* --------------------------
       Default Words (your list)
       Format per line: "Display | Clue"
       NOTE: ‚ÄúHighway 154‚Äù ‚Üí ‚ÄúOne Five Four‚Äù (no digits in grid)
    ---------------------------*/
    const DEFAULT_LINES = `Deetjens | Our cozy Big Sur inn.
Solvang | Danish town where we wandered.
Landsby | Our hotel in Solvang.
Kimpton | Santa Barbara hotel stay.
Honor Bar | Montecito spot for bites and drinks.
Donna | The orangutan we met.
Troll Hole | Found on a hike and in a Solvang crystal shop.
One Five Four | Road we took instead of 101.
Smoky the Bear | Forest fire prevention mascot we saw.
Pearl Jam | Band we blasted near Ventura.
Malibu | Coffee stop on the coast.
Art Bell | Late-night radio voice on the road.
Chinatown | Where we strolled in SF.
SLO | Dive-bar drink stop.
Mill City | Where deer surprised us by the bay.`.trim();

    /* --------------------------
       Utilities
    ---------------------------*/
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const sanitize = s => (s||"").toUpperCase().replace(/[^A-Z0-9]/g,""); // digits allowed but your list avoids them now
    const rand = n => Math.floor(Math.random()*n);
    const choice = arr => arr[rand(arr.length)];
    const encodeData = obj => { try{ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))) }catch(e){ return "" } };
    const decodeData = str => { try{ return JSON.parse(decodeURIComponent(escape(atob(str)))) }catch(e){ return null } };

    // vowel‚Äëfriendly filler with a beachy bias
    const FILLER_POOL = "AAAAAAAABBBCCCDDDEEEEEEEEEEEFFFGGGHHHHIIIIIIIJKKKLLLLLMMMNNNNNNOOOOOOOPPRRRRRSSSSSTTTTTTUUUVVWWXYYZBEACHWAVESLOVEGOLDENSUNSEA";

    function autoSize(words){
      const longest = Math.max(...words.map(w => w.word.length));
      const sum = words.reduce((a,w)=> a + w.word.length, 0);
      let s = Math.max(longest + 2, Math.ceil(Math.sqrt(sum) * 1.30));
      return Math.max(12, Math.min(22, s));
    }

    function buildWordObjects(lines){
      const out = [];
      lines.split(/\n/).map(l => l.trim()).filter(Boolean).forEach(line=>{
        const [display, ...rest] = line.split("|");
        const disp = (display||"").trim();
        const clue = (rest.join("|")||"").trim();
        const word = sanitize(disp);
        if(word.length >= 3){ out.push({ display: disp, word, clue: clue || disp }) }
      });
      return out;
    }

    /* --------------------------
       Generator
       Only forward directions: ‚Üí (0,1), ‚Üì (1,0), ‚Üò (1,1)
       NO reversed placements.
    ---------------------------*/
    function randomStart(dr, dc, len, size){
      let minR=0, maxR=size-1, minC=0, maxC=size-1;
      if(dr>0) maxR = size - len;
      if(dc>0) maxC = size - len;
      return { r: minR + rand(maxR-minR+1), c: minC + rand(maxC-minC+1) };
    }

    function tryPlace(grid, word, allowDiag){
      const size = grid.length;
      const dirs = allowDiag ? [[0,1],[1,0],[1,1]] : [[0,1],[1,0]];
      const len = word.word.length;
      for(let a=0;a<500;a++){
        const [dr,dc] = choice(dirs);
        const start = randomStart(dr,dc,len,size);
        let ok = true, cells=[];
        for(let i=0;i<len;i++){
          const r = start.r + dr*i, c = start.c + dc*i;
          const cell = grid[r][c], ch = word.word[i];
          if(cell && cell !== ch){ ok=false; break; }
          cells.push({r,c});
        }
        if(!ok) continue;
        // place
        for(let i=0;i<len;i++){
          const r=cells[i].r, c=cells[i].c;
          grid[r][c] = word.word[i];
        }
        return { ...word, cells };
      }
      return null;
    }

    function generate(words, size, allowDiag){
      const grid = Array.from({length:size},()=>Array(size).fill(""));
      const placements = [];
      const sorted = [...words].sort((a,b)=> b.word.length - a.word.length);
      for(const w of sorted){
        const placed = tryPlace(grid, w, allowDiag);
        if(!placed) return null;
        placements.push(placed);
      }
      // fill
      for(let r=0;r<size;r++){
        for(let c=0;c<size;c++){
          if(!grid[r][c]) grid[r][c] = choice(FILLER_POOL).toUpperCase()[0];
        }
      }
      return { grid, placements, size };
    }

    /* --------------------------
       Interaction
       Path only valid if it matches ‚Üí, ‚Üì, or ‚Üò
    ---------------------------*/
    function getCellFromPoint(x,y){
      const rect = gridEl.getBoundingClientRect();
      const size = STATE.size;
      const cell = rect.width / size;
      const c = Math.floor((x - rect.left) / cell);
      const r = Math.floor((y - rect.top ) / cell);
      if(r<0||c<0||r>=size||c>=size) return null;
      return {r,c};
    }

    function pathBetween(a,b){
      if(!a||!b) return [];
      const dr = b.r - a.r, dc = b.c - a.c;
      if(dr===0 && dc>=0){ // ‚Üí
        return Array.from({length:dc+1},(_,i)=>({r:a.r, c:a.c+i}));
      }else if(dc===0 && dr>=0){ // ‚Üì
        return Array.from({length:dr+1},(_,i)=>({r:a.r+i, c:a.c}));
      }else if(dr===dc && dr>=0){ // ‚Üò
        return Array.from({length:dr+1},(_,i)=>({r:a.r+i, c:a.c+i}));
      }else{
        return []; // invalid (blocks backwards and odd slants)
      }
    }

    function tryMatchPath(path){
      if(path.length<2) return false;
      const eq = (A,B) => A.length===B.length && A.every((p,i)=> p.r===B[i].r && p.c===B[i].c);
      for(let i=0;i<STATE.placements.length;i++){
        const cells = STATE.placements[i].cells;
        if(eq(path,cells)){
          STATE.found.add(i);
          updateFoundUI();
          return true;
        }
      }
      return false;
    }

    function clearSelecting(){
      STATE.selecting=false; STATE.startCell=null; STATE.currentPath=[];
      $$(".cell").forEach(n=> n.classList.remove("selecting"));
    }

    /* --------------------------
       UI render
    ---------------------------*/
    const gridEl = $("#grid");
    const cluesEl = $("#clues");
    const foundCountEl = $("#foundCount");
    const totalCountEl = $("#totalCount");
    const btnRegenerate = $("#btnRegenerate");
    const btnHighlight = $("#btnHighlight");
    const btnAnswers = $("#btnAnswers");
    const btnCloseWin = $("#btnCloseWin");
    const ribbon = $("#win");
    const winMsg = $("#winMsg");
    const logo = $("#logo");

    // Builder controls (hidden by default)
    const editorBox = $("#editorBox");
    const linesEl = $("#lines");
    const diagonalsEl = $("#diagonals");
    const autoSizeEl = $("#autoSize");
    const gridSizeEl = $("#gridSize");
    const btnApply = $("#btnApply");
    const btnShare = $("#btnShare");
    const btnReset = $("#btnReset");

    let STATE = {
      words: [],
      placements: [],
      grid: [],
      size: 16,
      allowDiagonals: true,
      found: new Set(),
      selecting:false,
      startCell:null,
      currentPath:[],
      answersShown:false,
      highlightAll:false
    };

    function renderGrid(){
      gridEl.style.setProperty("--size", STATE.size);
      gridEl.innerHTML = "";
      const frag = document.createDocumentFragment();
      for(let r=0;r<STATE.size;r++){
        for(let c=0;c<STATE.size;c++){
          const div = document.createElement("div");
          div.className = "cell";
          div.textContent = STATE.grid[r][c];
          div.dataset.r = r; div.dataset.c = c;
          frag.appendChild(div);
        }
      }
      gridEl.appendChild(frag);
    }

    function renderClues(){
      cluesEl.innerHTML = "";
      if(STATE.answersShown){ cluesEl.classList.add("show-answers"); }
      else { cluesEl.classList.remove("show-answers"); }
      STATE.placements.forEach((p, idx)=>{
        const li = document.createElement("li");
        li.dataset.idx = idx;
        const status = document.createElement("div");
        status.className = "status"; status.textContent = "‚ô°";
        const wrap = document.createElement("div");
        wrap.className = "clue-text";
        const ans = document.createElement("div");
        ans.className = "clue-answer";
        wrap.textContent = p.clue || p.display;
        ans.textContent = p.display;
        li.appendChild(status);
        li.appendChild(wrap);
        li.appendChild(ans);
        cluesEl.appendChild(li);
      });
      updateFoundUI();
    }

    function updateFoundUI(){
      foundCountEl.textContent = STATE.found.size;
      totalCountEl.textContent = STATE.placements.length;
      // clue statuses
      STATE.placements.forEach((p, idx)=>{
        const li = cluesEl.querySelector(`li[data-idx="${idx}"]`);
        if(!li) return;
        const found = STATE.found.has(idx);
        li.classList.toggle("found", found);
        li.querySelector(".status").textContent = found ? "‚úì" : "‚ô°";
      });
      // grid highlight
      $$(".cell").forEach(n=> n.classList.remove("found"));
      const indices = STATE.highlightAll ? STATE.placements.map((_,i)=>i) : Array.from(STATE.found);
      indices.forEach(idx=>{
        STATE.placements[idx].cells.forEach(({r,c})=>{
          const n = gridEl.children[r*STATE.size + c];
          if(n) n.classList.add("found");
        });
      });
      if(STATE.found.size === STATE.placements.length && !STATE.highlightAll){
        celebrate();
      }
    }

    function celebrate(){
      winMsg.textContent = "You‚Äôre my favorite adventure üíï";
      ribbon.classList.add("show");
      sprinkleHearts(24,true);
    }

    /* --------------------------
       Events
    ---------------------------*/
    gridEl.addEventListener("pointerdown",(e)=>{
      const cell = getCellFromPoint(e.clientX, e.clientY);
      if(!cell) return;
      STATE.selecting = true;
      STATE.startCell = cell;
      STATE.currentPath = [cell];
      gridEl.setPointerCapture(e.pointerId);
      const n = gridEl.children[cell.r*STATE.size + cell.c];
      if(n) n.classList.add("selecting");
    });
    gridEl.addEventListener("pointermove",(e)=>{
      if(!STATE.selecting) return;
      const cell = getCellFromPoint(e.clientX, e.clientY);
      if(!cell) return;
      const path = pathBetween(STATE.startCell, cell);
      $$(".cell").forEach(n=> n.classList.remove("selecting"));
      path.forEach(({r,c})=>{
        const n = gridEl.children[r*STATE.size + c];
        if(n) n.classList.add("selecting");
      });
      STATE.currentPath = path;
    });
    gridEl.addEventListener("pointerup",()=>{
      if(!STATE.selecting) return;
      const matched = tryMatchPath(STATE.currentPath);
      clearSelecting();
      if(matched){ sprinkleHearts(6,true); }
    });

    btnRegenerate.addEventListener("click", ()=> regenerate(true));
    btnHighlight.addEventListener("click", ()=>{
      STATE.highlightAll = !STATE.highlightAll;
      btnHighlight.textContent = STATE.highlightAll ? "Clear Highlights" : "Highlight All";
      updateFoundUI();
    });
    btnAnswers.addEventListener("click", ()=>{
      STATE.answersShown = !STATE.answersShown;
      btnAnswers.textContent = STATE.answersShown ? "Hide Answers" : "Show Answers";
      renderClues();
    });
    btnCloseWin.addEventListener("click", ()=> ribbon.classList.remove("show"));

    // Long‚Äëpress to reveal builder
    let lpTimer=null;
    logo.addEventListener("pointerdown", ()=>{
      lpTimer = setTimeout(()=> toggleBuilder(true), 1200);
    });
    ["pointerup","pointerleave","pointercancel"].forEach(ev=>{
      logo.addEventListener(ev, ()=> { clearTimeout(lpTimer); lpTimer=null; });
    });

    // Builder listeners (only exist in builder mode)
    if(btnApply) btnApply.addEventListener("click", ()=>{
      const words = buildWordObjects(linesEl.value);
      if(words.length===0) return alert("Please add at least one valid word (3+ characters).");
      STATE.words = words;
      regenerate(true);
    });
    if(btnShare) btnShare.addEventListener("click", ()=>{
      const payload = {
        t: $("#pageTitle").textContent,
        lines: linesEl.value.trim(),
        diag: diagonalsEl.checked,
        auto: autoSizeEl.checked,
        size: parseInt(gridSizeEl.value,10) || 16
      };
      const url = location.origin + location.pathname + "?edit=0#d=" + encodeData(payload);
      navigator.clipboard?.writeText(url).then(()=> alert("Share link copied! (Editor hidden)"),
                                            ()=> prompt("Copy your share link:", url));
    });
    if(btnReset) btnReset.addEventListener("click", ()=>{
      STATE.found = new Set();
      STATE.highlightAll = false;
      btnHighlight.textContent = "Highlight All";
      updateFoundUI();
    });

    /* --------------------------
       Orchestration
    ---------------------------*/
    function regenerate(){
      let size = parseInt($("#gridSize")?.value || STATE.size, 10);
      const allowDiag = $("#diagonals") ? $("#diagonals").checked : true;
      if($("#autoSize")?.checked){ size = autoSize(STATE.words); $("#gridSize").value = size; }
      let out=null, tries=0;
      while(tries<6){
        out = generate(STATE.words, size+tries, allowDiag);
        if(out) break;
        tries++;
      }
      if(!out) return alert("Couldn't fit all words. Increase grid size.");
      STATE.grid = out.grid;
      STATE.placements = out.placements;
      STATE.size = out.size;
      STATE.found = new Set();
      STATE.highlightAll = false;
      btnHighlight.textContent = "Highlight All";
      renderGrid(); renderClues();
      sprinkleHearts(10);
      saveLocal();
    }

    function saveLocal(){
      try{
        const payload = {
          lines: $("#lines")?.value || DEFAULT_LINES,
          diag: $("#diagonals")?.checked ?? true,
          auto: $("#autoSize")?.checked ?? true,
          size: parseInt($("#gridSize")?.value || "16",10),
          builder: document.body.classList.contains("builder")
        };
        localStorage.setItem("ws-love-v2", JSON.stringify(payload));
      }catch(e){}
    }
    function loadLocal(){
      try{
        const raw = localStorage.getItem("ws-love-v2");
        if(!raw) return false;
        const d = JSON.parse(raw);
        if(linesEl) linesEl.value = (d.lines || DEFAULT_LINES).trim();
        if(diagonalsEl) diagonalsEl.checked = !!d.diag;
        if(autoSizeEl) autoSizeEl.checked = !!d.auto;
        if(gridSizeEl) gridSizeEl.value = d.size || 16;
        if(d.builder) document.body.classList.add("builder");
        return true;
      }catch(e){ return false; }
    }

    function loadFromHash(){
      const m = (location.hash||"").match(/#d=([^&]+)/);
      if(!m) return false;
      const data = decodeData(m[1]);
      if(!data) return false;
      if(data.t) $("#pageTitle").textContent = data.t;
      if(linesEl) linesEl.value = (data.lines || DEFAULT_LINES).trim();
      if(diagonalsEl) diagonalsEl.checked = !!data.diag;
      if(autoSizeEl) autoSizeEl.checked = !!data.auto;
      if(gridSizeEl) gridSizeEl.value = data.size || 16;
      return true;
    }

    function toggleBuilder(forceOn){
      document.body.classList.toggle("builder", forceOn ?? !document.body.classList.contains("builder"));
      saveLocal();
    }

    function sprinkleHearts(n=12, faster=false){
      const box = $("#bgHearts");
      for(let i=0;i<n;i++){
        const s = document.createElement("span");
        s.textContent = Math.random()<0.3 ? "‚ô°" : "‚ù§";
        s.style.left = (Math.random()*100)+"vw";
        s.style.setProperty("--shift", (Math.random()*40-20)+"vw");
        s.style.animationDuration = (5 + Math.random()*(faster?4:10))+"s";
        s.style.animationDelay = (Math.random()*(faster?2.2:6))+"s";
        box.appendChild(s);
        setTimeout(()=> s.remove(), 16000);
      }
    }
    setInterval(()=> sprinkleHearts(rand(2)+1), 1600);

    function start(){
      // Builder mode via query param
      const params = new URLSearchParams(location.search);
      if(params.get("edit")==="1"){ document.body.classList.add("builder"); }

      const hadHash = loadFromHash();
      if(!hadHash){
        const hadLocal = loadLocal();
        if(!hadLocal && linesEl){ linesEl.value = DEFAULT_LINES; }
      }
      // Initialize words
      const source = (linesEl && linesEl.value && document.body.classList.contains("builder"))
        ? linesEl.value
        : DEFAULT_LINES;
      STATE.words = buildWordObjects(source);
      regenerate();
    }
    document.addEventListener("DOMContentLoaded", start);
  </script>
</body>
</html>
